name: Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        nvim-version: ["stable", "nightly"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Neovim
        uses: rhysd/action-setup-vim@v1
        with:
          neovim: true
          version: ${{ matrix.nvim-version }}

      - name: Verify Neovim version
        run: nvim --version

      - name: Bootstrap mini.nvim
        run: |
          # Let nvim auto-install mini.nvim on first run
          nvim --headless -c "lua vim.wait(2000, function() return false end)" -c "qall!" || true

      - name: Run smoke test
        run: |
          # Verify config loads without errors
          MINI_DEPS_LATER_AS_NOW=1 nvim --headless \
            -c "lua vim.wait(1000, function() return false end)" \
            -c "qall!"

      - name: Run CI tests
        run: |
          # Run only tests that don't require external tools (stylua, ruff, etc.)
          # This matches the local :RunTestCI command
          MINI_DEPS_LATER_AS_NOW=1 nvim --headless \
            -c "lua require('kyleking.utils.test_runner').run_ci_tests()" \
            -c "qall!"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Run pre-commit hooks
        run: pre-commit run --all-files
        env:
          # Skip hooks requiring tools not available in CI:
          # - stylua-system/selene: needs system binaries installed
          # - panvimdoc: path issues, docs generated locally
          # - generate-plugin-docs/helptags: needs nvim
          # - mini-test: already runs in test job
          SKIP: generate-plugin-docs,helptags,lua-diagnostics,mini-test,panvimdoc,selene,stylua-system
